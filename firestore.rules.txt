rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/artifacts/pirhei-aharon-app/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/artifacts/pirhei-aharon-app/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isTeacher() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/artifacts/pirhei-aharon-app/users/$(request.auth.uid)) &&
        (get(/databases/$(database)/documents/artifacts/pirhei-aharon-app/users/$(request.auth.uid)).data.role == 'teacher' ||
         get(/databases/$(database)/documents/artifacts/pirhei-aharon-app/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    function isSameUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isInClass(classId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/artifacts/pirhei-aharon-app/public/data/classes/$(classId)) &&
        (get(/databases/$(database)/documents/artifacts/pirhei-aharon-app/public/data/classes/$(classId)).data.students.hasAny([request.auth.uid]) ||
         get(/databases/$(database)/documents/artifacts/pirhei-aharon-app/public/data/classes/$(classId)).data.teachers.hasAny([request.auth.uid]));
    }

    // User data rules
    match /artifacts/pirhei-aharon-app/users/{userId} {
      allow read, write: if isSameUser(userId) || isAdmin();
    }
    
    // Public data rules
    match /artifacts/pirhei-aharon-app/public/data/{collection}/{document} {
      // Announcements - anyone can read, teachers/admins can write
      match /announcements/{announcementId} {
        allow read: if isAuthenticated();
        allow write: if isTeacher();
      }
      
      // Classes - anyone can read, teachers/admins can write
      match /classes/{classId} {
        allow read: if isAuthenticated();
        allow write: if isTeacher();
      }
      
      // Assignments - students can read their class assignments, teachers can manage
      match /assignments/{assignmentId} {
        allow read: if isAuthenticated() && 
          (isTeacher() || 
           isInClass(resource.data.classId));
        allow write: if isTeacher();
      }
      
      // Events - anyone can read, teachers/admins can write
      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow write: if isTeacher();
      }
      
      // Media - anyone can read, teachers/admins can write, admins can delete
      match /media/{mediaId} {
        allow read: if isAuthenticated();
        allow create: if isTeacher();
        allow update: if isTeacher();
        allow delete: if isAdmin();
      }
    }
  }
}